name: CI

on:
  push:
    branches:
      - master
#     tags:
#       - '*'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  # release-mac:
  #   runs-on: macos-latest
  #   steps:
  
  #     - name: Check out Git repository
  #       uses: actions/checkout@v3
  #       with:
  #         submodules: recursive
      
  #     - name: Install Node
  #       uses: actions/setup-node@v2
  #       with:
  #         node-version: '16'

  #     - name: Install Dependencies
  #       run: npm ci
        
  #     - name: Setup Extra Resources
  #       run: |
  #         mkdir -p extra_resources/.platformio/
  #         mkdir -p extra_resources/yetenek12-library/
  #         rsync -a yetenek-ide-pio-mac/* extra_resources/.platformio/
  #         rsync -a yetenek12-library/* extra_resources/yetenek12-library/
  #         rsync -a ./src/workspace.xml extra_resources/workspace.xml
  #       shell: bash

  #     - name: Rebuild App
  #       run: npm run rebuild-app
  #       shell: bash
        
  #     - name: Build App
  #       run: npm run build-app
  #       shell: bash
  #       env:
  #         CSC_IDENTITY_AUTO_DISCOVERY: false
  #         GH_TOKEN: ${{ secrets.github_token }}
        
  #     - name: Release App
  #       uses: softprops/action-gh-release@v1
  #       if: startsWith(github.ref, 'refs/tags/v')
  #       with:
  #         token: ${{ secrets.GITHUB_TOKEN }}
  #         files: build/**.dmg

  release-win:
    runs-on: windows-latest
    steps:
    
      - name: Check out Git repository
        uses: actions/checkout@v3
        with:
          submodules: recursive
      
      - uses: actions/setup-python@v3
        with:
          python-version: '2.7'
          architecture: 'x64'
          
      - name: Install Node
        uses: actions/setup-node@v2
        with:
          node-version: '16'
          
      - name: Set Python Version
        run: npm config set python python2.7

      - name: Install Dependencies
        run: npm ci
        
      - name: Setup Extra Resources
        run: |
          mkdir .\extra_resources\
          xcopy ".\yetenek-ide-pio-windows\" ".\extra_resources\.platformio\" /e /i /y /c /q
          xcopy ".\yetenek12-library\" ".\extra_resources\yetenek12-library\" /e /i /y /c /q
          copy ".\src\workspace.xml" ".\extra_resources\workspace.xml"
        
      - name: Rebuild App
        run: cmd.exe /c npm run rebuild-app >NUL 2>&1
        
      - name: Build App
        run: npm run build-app
        env:
          GH_TOKEN: ${{ secrets.github_token }}
        
      - name: Release App
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          files: build/**.exe
